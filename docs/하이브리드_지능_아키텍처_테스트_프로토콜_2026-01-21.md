# 🏛️ 하이브리드 지능 아키텍처 테스트 프로토콜

**작성일**: 2026-01-21  
**목적**: 로컬 우선 + VPS 폴백 전략 검증  
**상태**: ✅ 구현 완료, 테스트 대기

---

## 🎯 핵심 아키텍처

### 하이브리드 전환 전략

```
사용자 질문
  ↓
[1초 타임아웃] 로컬 Ollama 연결 시도
  ├─ ✅ 성공 → athena-merged-v1:latest 사용 (0.3-0.5초 응답)
  │   └─ 폴백: llama3.1:8b → gemma3:4b
  └─ ❌ 실패 → VPS gemma3:4b 사용 (2-5초 응답)
  ↓
[30초 캐시] 다음 요청은 캐시된 URL 재사용
```

---

## 🚀 테스트 프로토콜

### [Nitro Test] PC 켜짐 상태 (로컬 우선)

**목적**: 로컬 GPU 가동 확인 및 성능 측정

**준비 사항**:
- ✅ 로컬 PC 24시간 가동 중
- ✅ Ollama 서비스 실행 중 (`http://localhost:11434`)
- ✅ `athena-merged-v1:latest` 모델 설치 확인

**테스트 절차**:

1. **브라우저 콘솔 열기** (F12)
2. **질문 입력**: "비트코인 전망해봐."
3. **측정 항목**:
   - 첫 토큰 지연 시간 (TTFT)
   - 전체 응답 시간
   - 사용된 모델 (콘솔 로그 확인)

**기대 결과**:
- ✅ 첫 토큰: **0.3-0.5초** 내 시작
- ✅ 전체 응답: **0.5-1초** 내 완료
- ✅ 콘솔 로그: `[Ollama] 로컬 연결 성공, 로컬 우선 사용`
- ✅ 모델: `athena-merged-v1:latest`

**성공 기준**:
- 첫 토큰 < 1초
- 전체 응답 < 2초
- 로컬 모델 사용 확인

---

### [Survival Test] PC 꺼짐 상태 (VPS 폴백)

**목적**: VPS 자동 폴백 확인 및 서비스 중단 방지

**준비 사항**:
- ⚠️ 로컬 PC의 Tailscale 종료 (또는 Ollama 서비스 중지)
- ✅ VPS Ollama 서비스 실행 중 (`http://148.230.97.246:11434`)

**테스트 절차**:

1. **로컬 연결 차단**:
   ```powershell
   # 방법 1: Tailscale 종료
   # 방법 2: Ollama 서비스 중지
   # 방법 3: 방화벽에서 localhost:11434 차단
   ```

2. **브라우저 콘솔 열기** (F12)
3. **질문 입력**: "지금 내 기분 어때?"
4. **측정 항목**:
   - 타임아웃 지연 시간 (1초)
   - VPS 폴백 시간
   - 전체 응답 시간

**기대 결과**:
- ✅ 타임아웃: **1초** 후 로컬 실패 감지
- ✅ 첫 토큰: **1-3초** 내 시작 (VPS 네트워크 지연)
- ✅ 전체 응답: **2-5초** 내 완료
- ✅ 콘솔 로그: `[Ollama] 로컬 연결 실패, VPS 폴백`
- ✅ 모델: `gemma3:4b`

**성공 기준**:
- 서비스 중단 없음 (VPS 폴백 성공)
- 응답 시간 < 5초
- VPS 모델 사용 확인

---

## 📊 성능 벤치마크

### 로컬 (athena-merged-v1:latest)

| 항목 | 목표 | 측정값 | 상태 |
|------|------|--------|------|
| 첫 토큰 (TTFT) | < 0.5초 | ? | 측정 필요 |
| 전체 응답 | < 1초 | ? | 측정 필요 |
| 모델 크기 | 8B | 4.9GB | ✅ |
| GPU 사용률 | > 80% | ? | 측정 필요 |

### VPS 폴백 (gemma3:4b)

| 항목 | 목표 | 측정값 | 상태 |
|------|------|--------|------|
| 첫 토큰 (TTFT) | < 3초 | ? | 측정 필요 |
| 전체 응답 | < 5초 | ? | 측정 필요 |
| 모델 크기 | 4.3B | 3.3GB | ✅ |
| 네트워크 지연 | < 200ms | ? | 측정 필요 |

---

## 🔍 콘솔 로그 확인

### 로컬 연결 성공 시

```
[API] 하이브리드 Ollama 전략 활성화 (로컬 우선 → VPS 폴백)
[Ollama] 로컬 연결 성공, 로컬 우선 사용
[Gemma3 Streaming] 요청 시작: { prompt: '비트코인 전망해봐.', url: 'http://localhost:11434', model: 'athena-merged-v1:latest' }
```

### VPS 폴백 시

```
[API] 하이브리드 Ollama 전략 활성화 (로컬 우선 → VPS 폴백)
[Ollama] 로컬 연결 실패, VPS 폴백: AbortError: The operation was aborted
[Ollama] VPS 사용: http://148.230.97.246:11434
[Gemma3 Streaming] 요청 시작: { prompt: '지금 내 기분 어때?', url: 'http://148.230.97.246:11434', model: 'gemma3:4b' }
```

---

## ✅ 체크리스트

### Nitro Test (로컬)

- [ ] 로컬 Ollama 서비스 실행 확인
- [ ] `athena-merged-v1:latest` 모델 설치 확인
- [ ] 질문 입력 후 첫 토큰 < 1초 확인
- [ ] 전체 응답 < 2초 확인
- [ ] 콘솔 로그에서 로컬 연결 확인
- [ ] 모델 `athena-merged-v1:latest` 사용 확인

### Survival Test (VPS 폴백)

- [ ] 로컬 연결 차단 (Tailscale 종료 또는 Ollama 중지)
- [ ] 질문 입력 후 1초 타임아웃 확인
- [ ] VPS 폴백 성공 확인
- [ ] 전체 응답 < 5초 확인
- [ ] 콘솔 로그에서 VPS 폴백 확인
- [ ] 모델 `gemma3:4b` 사용 확인

---

## 🎯 최종 승인 기준

### 성능 기준

- ✅ 로컬 첫 토큰 < 1초
- ✅ 로컬 전체 응답 < 2초
- ✅ VPS 폴백 성공률 100%
- ✅ 서비스 중단 시간 0초

### 안정성 기준

- ✅ 로컬 실패 시 자동 VPS 전환
- ✅ VPS 실패 시 명확한 에러 메시지
- ✅ 30초 캐시로 성능 최적화

---

## 📝 테스트 결과 기록

### Nitro Test 결과

**테스트 일시**: YYYY-MM-DD HH:MM:SS  
**첫 토큰**: ? ms  
**전체 응답**: ? ms  
**사용 모델**: athena-merged-v1:latest  
**상태**: ✅ 성공 / ❌ 실패

### Survival Test 결과

**테스트 일시**: YYYY-MM-DD HH:MM:SS  
**타임아웃**: ? ms  
**첫 토큰**: ? ms  
**전체 응답**: ? ms  
**사용 모델**: gemma3:4b  
**상태**: ✅ 성공 / ❌ 실패

---

**작성일**: 2026-01-21  
**상태**: ✅ 테스트 프로토콜 준비 완료  
**다음 단계**: Vercel 배포 완료 후 테스트 실행

[Verified by Athena Auditor v1.2]

